<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dept Events & Trainings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- IMPORTANT: Load the configuration file -->
    <script src="config.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; overflow: hidden; }
        .event-card { transition: transform 0.2s ease, background-color 0.2s ease; border: 1px solid #1e293b; }
        .event-card:hover { transform: translateY(-2px); background-color: #1e293b; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .skeleton-shimmer::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.03) 20%, rgba(255, 255, 255, 0.08) 60%, rgba(255, 255, 255, 0)); animation: shimmer 1.8s infinite; }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 antialiased">

    <div class="w-full h-screen p-6 md:p-8 flex flex-col">
        <header class="p-6 mb-12 flex-shrink-0 bg-slate-900 rounded-lg shadow-lg text-left border border-slate-800 flex justify-between items-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">MEETINGS, TRAININGS, AND EVENTS</h1>
            <a href="config.html" target="_blank" class="text-slate-600 hover:text-cyan-400 transition-colors" title="Open Configurator">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </a>
        </header>

        <main class="flex-grow">
            <div id="events-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                 <div id="loading-skeleton" class="grid grid-cols-1 md:grid-cols-2 gap-8 col-span-2">
                    <!-- Skeletons -->
                    <div class="relative overflow-hidden flex items-start gap-6 p-6 min-h-[150px] bg-slate-900 rounded-lg border border-slate-800 skeleton-shimmer"><div class="flex-shrink-0 w-20 h-20 bg-slate-800 rounded-md mt-1"></div><div class="flex-grow space-y-3 pt-1"><div class="h-6 bg-slate-800 rounded w-3/4"></div><div class="h-5 bg-slate-800 rounded w-1/2"></div><div class="h-5 bg-slate-800 rounded w-full mt-4"></div></div></div>
                    <div class="relative overflow-hidden flex items-start gap-6 p-6 min-h-[150px] bg-slate-900 rounded-lg border border-slate-800 skeleton-shimmer"><div class="flex-shrink-0 w-20 h-20 bg-slate-800 rounded-md mt-1"></div><div class="flex-grow space-y-3 pt-1"><div class="h-6 bg-slate-800 rounded w-3/4"></div><div class="h-5 bg-slate-800 rounded w-1/2"></div><div class="h-5 bg-slate-800 rounded w-full mt-4"></div></div></div>
                    <div class="relative overflow-hidden flex items-start gap-6 p-6 min-h-[150px] bg-slate-900 rounded-lg border border-slate-800 skeleton-shimmer"><div class="flex-shrink-0 w-20 h-20 bg-slate-800 rounded-md mt-1"></div><div class="flex-grow space-y-3 pt-1"><div class="h-6 bg-slate-800 rounded w-3/4"></div><div class="h-5 bg-slate-800 rounded w-1/2"></div><div class="h-5 bg-slate-800 rounded w-full mt-4"></div></div></div>
                    <div class="relative overflow-hidden flex items-start gap-6 p-6 min-h-[150px] bg-slate-900 rounded-lg border border-slate-800 skeleton-shimmer"><div class="flex-shrink-0 w-20 h-20 bg-slate-800 rounded-md mt-1"></div><div class="flex-grow space-y-3 pt-1"><div class="h-6 bg-slate-800 rounded w-3/4"></div><div class="h-5 bg-slate-800 rounded w-1/2"></div><div class="h-5 bg-slate-800 rounded w-full mt-4"></div></div></div>
                 </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const eventsContainer = document.getElementById('events-container');
            
            // Check if Config is loaded
            if (typeof CALENDAR_CONFIG === 'undefined') {
                eventsContainer.innerHTML = `
                    <div class="col-span-2 text-center py-20 bg-slate-900 rounded-lg border border-red-900 text-red-400">
                        <h2 class="text-xl font-bold">Configuration Missing</h2>
                        <p class="mt-2">Please run config.html, click "Download Config", and save the file as <code>config.js</code> in this folder.</p>
                    </div>`;
                return;
            }

            // Safe property accessor for nested keys (e.g. "start.dateTime")
            function getNested(obj, path) {
                if (!path) return undefined;
                return path.split('.').reduce((acc, part) => acc && acc[part], obj);
            }

            function getDateParts(dateStr) {
                if (!dateStr) return { month: '', day: '', time: 'TBD' };
                const date = new Date(dateStr);
                const month = date.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                const day = date.toLocaleDateString('en-US', { day: '2-digit' });
                // Force 24-hour format
                const time = dateStr.includes('T') 
                    ? date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }) 
                    : 'All-Day';
                return { month, day, time };
            }

            async function loadEvents() {
                const { apiKey, calendarId, mapping, textFilter } = CALENDAR_CONFIG;

                if (!apiKey || !calendarId) {
                    eventsContainer.innerHTML = '<p class="text-red-500">API Key or Calendar ID missing in config.js</p>';
                    return;
                }
                
                const timeMin = new Date().toISOString();
                const apiUrl = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?key=${apiKey}&timeMin=${timeMin}&singleEvents=true&orderBy=startTime`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(response.statusText);
                    const data = await response.json();
                    
                    renderEvents((data.items || []).slice(0, 10));
                } catch (error) {
                    console.error('Error:', error);
                    eventsContainer.innerHTML = `<div class="col-span-2 text-center text-red-500 py-10">Failed to load events. Check console for details.</div>`;
                }
            }

            function renderEvents(events) {
                eventsContainer.innerHTML = '';
                const { mapping, textFilter } = CALENDAR_CONFIG;

                if (events.length === 0) {
                    eventsContainer.innerHTML = `<div class="col-span-2 text-center text-slate-500 py-20">No upcoming events found.</div>`;
                    return;
                }

                events.forEach(event => {
                    // 1. Get Title and Apply Filters (Array support added)
                    let title = getNested(event, mapping.title) || 'Untitled Event';
                    
                    if (textFilter) {
                        // Support both string (legacy) and array (new)
                        const filters = Array.isArray(textFilter) ? textFilter : [textFilter];
                        filters.forEach(filterStr => {
                            if (filterStr && filterStr.length > 0) {
                                // Split/Join is a simple way to replace ALL occurrences without Regex special char issues
                                title = title.split(filterStr).join('').trim();
                            }
                        });
                    }
                    
                    if (!title) return; // Skip if title becomes empty

                    // 2. Get Dates
                    const startRaw = getNested(event, mapping.start) || getNested(event, 'start.date');
                    const { month, day, time } = getDateParts(startRaw);

                    // 3. Other fields
                    let location = getNested(event, mapping.location);
                    if (!location) {
                        location = 'Pleasant Fire';
                    } else if (location === 'HTFD') {
                        location = 'Harmony Fire';
                    }
                    
                    const description = getNested(event, mapping.description);

                    // 4. Icons
                    const timeIcon = `<svg class="inline-block mr-1.5 align-middle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
                    const locIcon = `<svg class="inline-block mr-1.5 align-middle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`;

                    const el = document.createElement('div');
                    el.className = 'event-card bg-slate-900 rounded-lg flex items-start p-6 gap-6';
                    el.innerHTML = `
                        <div class="date-block text-center flex-shrink-0 w-20 bg-slate-800/70 rounded-lg p-3 border border-slate-700">
                            <p class="month text-sm font-bold text-cyan-400 tracking-wider">${month}</p>
                            <p class="day text-4xl font-extrabold text-white tracking-tight">${day}</p>
                        </div>
                        <div class="details flex-grow">
                            <h3 class="font-bold text-white text-lg md:text-xl leading-tight">${title}</h3>
                            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4 text-base text-slate-400 mt-2">
                                <span class="flex items-center">${timeIcon} ${time}</span>
                                <span class="flex items-center mt-1 sm:mt-0">${locIcon} ${location}</span>
                            </div>
                            ${description ? `<p class="text-base text-slate-400 mt-4 prose prose-invert max-w-none line-clamp-3">${description}</p>` : ''}
                        </div>
                    `;
                    eventsContainer.appendChild(el);
                });
            }
            
            loadEvents();
        });
    </script>
</body>
</html>