<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Form Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary-red: #b02a37; --dark-bg: #212529; }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        .navbar { background-color: var(--dark-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .navbar-brand { color: white !important; font-weight: 700; letter-spacing: 0.5px; }

        .main-card { border: none; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05); border-radius: 0.5rem; }
        
        .section-card { border: 1px solid #e9ecef; border-left: 5px solid var(--primary-red); transition: all 0.2s; }
        .section-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .drag-handle { cursor: grab; color: #adb5bd; padding-top: 4px; }
        .drag-handle:hover { color: var(--primary-red); }
        .ghost { opacity: 0.4; background: #e2e6ea; border: 2px dashed #adb5bd; }

        .field-wrapper .card { background-color: #fff; border: 1px solid #dee2e6; }
        .btn-dashed { border: 2px dashed #dee2e6; color: #6c757d; font-weight: 600; background: #fff; }
        .btn-dashed:hover { border-color: var(--primary-red); color: var(--primary-red); background: #fff5f5; }

        /* Type Selection Buttons */
        .type-btn { text-align: left; padding: 15px; border: 1px solid #dee2e6; transition: all 0.2s; background: #fff; }
        .type-btn:hover { background: #f8f9fa; border-color: var(--primary-red); transform: translateY(-2px); }
        .type-icon { font-size: 1.5rem; color: var(--primary-red); margin-right: 15px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4 px-4">
    <div class="container-fluid max-w-1000">
        <span class="navbar-brand"><i class="bi bi-fire me-2"></i> FD Form Admin</span>
        <div>
             <a href="index.html" class="btn btn-sm btn-outline-light me-2">Go to Forms</a>
             <a href="records.html" class="btn btn-sm btn-outline-light">View Records</a>
        </div>
    </div>
</nav>

<div class="container" style="max-width: 1000px;">
    
    <div class="card main-card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0 fw-bold text-secondary">Form Builder</h3>
            <div>
                <button class="btn btn-outline-secondary btn-sm" onclick="resetBuilder()"><i class="bi bi-plus-lg"></i> New Form</button>
                <button class="btn btn-danger btn-sm d-none" id="deleteBtn"><i class="bi bi-trash"></i> Delete</button>
                <button class="btn btn-primary btn-sm ms-2" id="saveBtn"><i class="bi bi-save"></i> Save Form</button>
            </div>
        </div>

        <div class="bg-light p-3 rounded mb-4 border">
            <label class="small text-uppercase text-muted fw-bold mb-1">Load Existing Form</label>
            <select id="existingForms" class="form-select border-0 shadow-none bg-white">
                <option value="">-- Select a form to edit --</option>
            </select>
        </div>

        <div class="mb-2">
            <label class="form-label fw-bold">Form Title</label>
            <input type="text" id="formTitle" class="form-control form-control-lg" placeholder="e.g., Engine 1 Daily Check">
        </div>
    </div>

    <div id="sectionsContainer"></div>

    <div class="text-center mt-4 mb-5">
        <button class="btn btn-dashed w-100 p-3" onclick="addSection()">
            <i class="bi bi-folder-plus fs-5"></i><br>Add New Section
        </button>
    </div>
</div>

<div class="modal fade" id="typeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Select Question Type</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-light p-4">
        <div class="row g-3">
            <div class="col-md-6">
                <button class="btn w-100 type-btn d-flex align-items-center" onclick="confirmAddType('text')">
                    <i class="bi bi-input-cursor-text type-icon"></i>
                    <div><div class="fw-bold">Short Text</div><small class="text-muted">Names, Mileage, Fuel Level</small></div>
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn w-100 type-btn d-flex align-items-center" onclick="confirmAddType('textarea')">
                    <i class="bi bi-textarea-resize type-icon"></i>
                    <div><div class="fw-bold">Long Text</div><small class="text-muted">Notes, Description, Comments</small></div>
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn w-100 type-btn d-flex align-items-center" onclick="confirmAddType('number')">
                    <i class="bi bi-123 type-icon"></i>
                    <div><div class="fw-bold">Number</div><small class="text-muted">PSI, Counts, Hours</small></div>
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn w-100 type-btn d-flex align-items-center" onclick="confirmAddType('date')">
                    <i class="bi bi-calendar-event type-icon"></i>
                    <div><div class="fw-bold">Date</div><small class="text-muted">Checkoff Date, Expiration</small></div>
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn w-100 type-btn d-flex align-items-center" onclick="confirmAddType('checkbox')">
                    <i class="bi bi-check-square type-icon"></i>
                    <div><div class="fw-bold">Checkbox</div><small class="text-muted">Pass/Fail, Yes/No</small></div>
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn w-100 type-btn d-flex align-items-center" onclick="confirmAddType('dropdown')">
                    <i class="bi bi-list-ul type-icon"></i>
                    <div><div class="fw-bold">Dropdown Menu</div><small class="text-muted">Select from a list of options</small></div>
                </button>
            </div>
            <div class="col-12">
                <button class="btn w-100 type-btn d-flex align-items-center" onclick="confirmAddType('signature')">
                    <i class="bi bi-pen type-icon"></i>
                    <div><div class="fw-bold">Signature</div><small class="text-muted">Touch screen signature pad</small></div>
                </button>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { db, collection, addDoc, getDocs, doc, setDoc, deleteDoc } from './firebase-config.js';

    let editingFormId = null;
    let targetSectionContainer = null; // Stores where we want to add the question
    const typeModal = new bootstrap.Modal(document.getElementById('typeModal'));

    new Sortable(document.getElementById('sectionsContainer'), {
        animation: 150, handle: '.section-handle', ghostClass: 'ghost'
    });

    // 1. Open Modal instead of adding immediately
    window.openTypeModal = function(btn) {
        targetSectionContainer = btn.closest('.card-body').querySelector('.fields-container');
        typeModal.show();
    }

    // 2. Handle Selection from Modal
    window.confirmAddType = function(type) {
        if(targetSectionContainer) {
            addField(targetSectionContainer, { type: type });
        }
        typeModal.hide();
    }

    window.addSection = function(title = '') {
        const div = document.createElement('div');
        div.className = 'card mb-4 section-card shadow-sm';
        div.innerHTML = `
            <div class="card-header d-flex align-items-center bg-white py-3">
                <i class="bi bi-grip-vertical fs-4 me-3 section-handle drag-handle"></i>
                <input type="text" class="form-control fw-bold border-0 bg-transparent fs-5 section-title" 
                       value="${title}" placeholder="Section Title">
                <button class="btn btn-sm text-danger ms-auto" onclick="this.closest('.card').remove()"><i class="bi bi-trash"></i></button>
            </div>
            <div class="card-body bg-light">
                <div class="fields-container row g-3"></div>
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-outline-secondary bg-white" onclick="openTypeModal(this)">
                        <i class="bi bi-plus-circle"></i> Add Question
                    </button>
                </div>
            </div>
        `;
        document.getElementById('sectionsContainer').appendChild(div);

        new Sortable(div.querySelector('.fields-container'), {
            animation: 150, group: 'shared-fields', handle: '.field-handle', ghostClass: 'ghost'
        });
        return div.querySelector('.fields-container');
    };

    window.addField = function(container, data = {}) {
        const div = document.createElement('div');
        const widthClass = data.width ? `col-md-${data.width}` : 'col-md-12';
        
        // Show options box if dropdown is selected initially OR passed in data
        const type = data.type || 'text';
        const showOptions = type === 'dropdown' ? '' : 'd-none';
        const isRequired = data.required ? 'checked' : ''; 

        div.className = `${widthClass} field-wrapper`; 
        div.innerHTML = `
            <div class="card p-3 h-100 shadow-sm position-relative">
                <div class="d-flex gap-2">
                    <i class="bi bi-grip-vertical fs-5 field-handle drag-handle pt-1"></i>
                    
                    <div class="flex-grow-1">
                        <input type="text" class="form-control form-control-sm mb-2 fw-bold border-0 bg-light field-label" 
                               placeholder="Question Label" value="${data.label || ''}">
                        
                        <input type="text" class="form-control form-control-sm mb-2 bg-white border-warning text-warning options-input ${showOptions}" 
                               placeholder="Comma separated options (e.g. Red, Blue, Green)" value="${data.options || ''}">

                        <div class="row g-2">
                            <div class="col-5">
                                <select class="form-select form-select-sm field-type" onchange="toggleOptions(this)">
                                    <option value="text" ${type === 'text' ? 'selected' : ''}>Short Text</option>
                                    <option value="textarea" ${type === 'textarea' ? 'selected' : ''}>Long Text</option>
                                    <option value="number" ${type === 'number' ? 'selected' : ''}>Number</option>
                                    <option value="date" ${type === 'date' ? 'selected' : ''}>Date</option>
                                    <option value="checkbox" ${type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                                    <option value="dropdown" ${type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                                    <option value="signature" ${type === 'signature' ? 'selected' : ''}>Signature</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <select class="form-select form-select-sm field-width" onchange="updateWidth(this)">
                                    <option value="12" ${data.width == 12 ? 'selected' : ''}>Full Width</option>
                                    <option value="9" ${data.width == 9 ? 'selected' : ''}>3/4 Width</option>
                                    <option value="6" ${data.width == 6 ? 'selected' : ''}>1/2 Width</option>
                                    <option value="4" ${data.width == 4 ? 'selected' : ''}>1/3 Width</option>
                                    <option value="3" ${data.width == 3 ? 'selected' : ''}>1/4 Width</option>
                                </select>
                            </div>
                             <div class="col-3 d-flex align-items-center">
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input field-required" type="checkbox" ${isRequired}>
                                    <label class="form-check-label small" style="font-size:0.7rem;">Req</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-close btn-sm" onclick="this.closest('.field-wrapper').remove()"></button>
                </div>
            </div>
        `;
        container.appendChild(div);
    };

    window.toggleOptions = function(select) {
        const wrapper = select.closest('.field-wrapper');
        const optionsInput = wrapper.querySelector('.options-input');
        if(select.value === 'dropdown') optionsInput.classList.remove('d-none');
        else optionsInput.classList.add('d-none');
    }

    window.updateWidth = function(select) {
        const wrapper = select.closest('.field-wrapper');
        wrapper.classList.remove('col-md-12', 'col-md-9', 'col-md-6', 'col-md-4', 'col-md-3');
        wrapper.classList.add(`col-md-${select.value}`);
    };

    document.getElementById('saveBtn').addEventListener('click', async () => {
        const title = document.getElementById('formTitle').value;
        if(!title) return alert("Title required");

        const sections = [];
        document.querySelectorAll('.section-card').forEach(secCard => {
            const fields = [];
            secCard.querySelectorAll('.field-wrapper').forEach(fieldWrap => {
                fields.push({
                    label: fieldWrap.querySelector('.field-label').value,
                    type: fieldWrap.querySelector('.field-type').value,
                    width: fieldWrap.querySelector('.field-width').value,
                    options: fieldWrap.querySelector('.options-input').value,
                    required: fieldWrap.querySelector('.field-required').checked 
                });
            });
            sections.push({ title: secCard.querySelector('.section-title').value, fields: fields });
        });

        const formData = { title, structure: 'v2', sections, updatedAt: new Date() };

        try {
            if (editingFormId) {
                await setDoc(doc(db, "forms", editingFormId), formData, { merge: true });
                alert("Updated!");
            } else {
                formData.createdAt = new Date();
                await addDoc(collection(db, "forms"), formData);
                alert("Created!");
            }
            window.location.reload();
        } catch(e) { console.error(e); alert("Error: " + e.message); }
    });

    async function loadFormDropdown() {
        const select = document.getElementById('existingForms');
        const snapshot = await getDocs(collection(db, "forms"));
        snapshot.forEach(doc => {
            const opt = document.createElement('option');
            opt.value = doc.id;
            opt.innerText = doc.data().title;
            opt.dataset.formData = JSON.stringify(doc.data());
            select.appendChild(opt);
        });
    }

    document.getElementById('existingForms').addEventListener('change', (e) => {
        if (!e.target.value) return;
        const data = JSON.parse(e.target.selectedOptions[0].dataset.formData);
        editingFormId = e.target.value;
        document.getElementById('formTitle').value = data.title;
        document.getElementById('deleteBtn').classList.remove('d-none');
        document.getElementById('sectionsContainer').innerHTML = '';

        if(data.structure === 'v2') {
            data.sections.forEach(sec => {
                const container = addSection(sec.title);
                sec.fields.forEach(f => addField(container, f));
            });
        }
    });

    document.getElementById('deleteBtn').addEventListener('click', async () => {
        if(confirm("Delete this form?")) {
            await deleteDoc(doc(db, "forms", editingFormId));
            window.location.reload();
        }
    });

    loadFormDropdown();
</script>
</body>
</html>