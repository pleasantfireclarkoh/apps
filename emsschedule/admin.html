<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">Schedule Manager</h1>
            <div class="flex gap-3">
                <button id="open-text-import" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Paste Text
                </button>

                <a href="schedule.html" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-sm transition-colors">
                    &larr; Back to Viewer
                </a>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-indigo-400">Add New Shift</h2>
            <form id="add-shift-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-1">
                    <label class="block text-xs font-medium text-slate-400 mb-1">Date</label>
                    <input type="date" id="add-date" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs font-medium text-slate-400 mb-1">Shift Time</label>
                    <input type="text" id="add-time" placeholder="e.g. 06:00 - 18:00" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs font-medium text-slate-400 mb-1">Crew Member 1</label>
                    <input type="text" id="add-crew1" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs font-medium text-slate-400 mb-1">Crew Member 2</label>
                    <input type="text" id="add-crew2" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-xs font-medium text-slate-400 mb-1">Trainee (Optional)</label>
                    <input type="text" id="add-trainee" placeholder="Leave empty if none" class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                </div>
                <div class="col-span-1 md:col-span-2 mt-2">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded transition-colors">Create Shift</button>
                </div>
            </form>
        </div>

        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg overflow-hidden">
            <div class="p-4 bg-slate-800 border-b border-slate-700">
                <h2 class="text-lg font-semibold text-white">All Shifts <span class="text-xs font-normal text-slate-400 ml-2">(Click row to edit)</span></h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-700/50 text-slate-300 text-sm uppercase">
                        <tr>
                            <th class="p-4 font-medium">Date</th>
                            <th class="p-4 font-medium">Crew</th>
                            <th class="p-4 font-medium text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="shift-list" class="divide-y divide-slate-700 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-lg flex flex-col">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Edit Shift</h3>
                <button id="close-edit-modal" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6">
                <form id="edit-form" class="space-y-4">
                    <input type="hidden" id="edit-doc-id">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Shift Time</label>
                        <input type="text" id="edit-time" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1">Crew 1</label>
                            <input type="text" id="edit-crew1" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1">Crew 2</label>
                            <input type="text" id="edit-crew2" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Trainee</label>
                        <input type="text" id="edit-trainee" class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-indigo-500 focus:outline-none text-white">
                    </div>
                    <div class="pt-4 flex gap-3">
                         <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="text-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-4xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Paste Schedule Text</h3>
                <button id="close-text-modal" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 flex-1 flex flex-col overflow-hidden">
                <p class="text-sm text-slate-400 mb-2">Copy the entire schedule text and paste it below:</p>
                <textarea id="raw-text-input" class="flex-1 w-full bg-slate-900 border border-slate-600 rounded p-4 text-xs font-mono text-slate-300 focus:border-indigo-500 focus:outline-none custom-scrollbar" placeholder="Dec 1\nDay Shift\nMedic 06-18Tyler Franklin06-18..."></textarea>
            </div>
            <div class="p-6 border-t border-slate-700 bg-slate-900/50 flex justify-end gap-3">
                <button id="process-text-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold shadow-lg">
                    Parse Text
                </button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Review Import</h3>
                <button id="close-modal" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <p class="text-slate-400 text-sm mb-4">
                    We found the following shifts. Uncheck any incorrect entries.
                </p>
                <div id="import-preview" class="space-y-2"></div>
            </div>
            <div class="p-6 border-t border-slate-700 bg-slate-900/50 flex justify-end gap-3">
                <button id="cancel-import" class="px-4 py-2 text-slate-300 hover:text-white font-medium">Cancel</button>
                <button id="confirm-import" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded font-bold shadow-lg shadow-green-900/20">
                    Import Selected (<span id="import-count">0</span>)
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // UPDATED CONFIGURATION (pleasant-fire)
        const firebaseConfig = {
          apiKey: "AIzaSyBsaM_8RjTsgaSOPrOkyaK1DXghCHumxkc",
          authDomain: "pleasant-fire.firebaseapp.com",
          projectId: "pleasant-fire",
          storageBucket: "pleasant-fire.firebasestorage.app",
          messagingSenderId: "107375626982",
          appId: "1:107375626982:web:97eed5f81377b15eba8927",
          measurementId: "G-TT4G7K37M2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Use consistent App ID 'pleasant-township-app' (Important for migration)
        const appId = 'pleasant-township-app';

        let importedShifts = [];
        let existingShifts = []; // Store current DB state for duplication checking

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        const addForm = document.getElementById('add-shift-form');
        const editForm = document.getElementById('edit-form');
        const shiftList = document.getElementById('shift-list');
        const editModal = document.getElementById('edit-modal');
        const modal = document.getElementById('import-modal');
        const textModal = document.getElementById('text-modal');
        const previewContainer = document.getElementById('import-preview');
        const importCount = document.getElementById('import-count');

        const formatDateUS = (val) => {
            if (!val) return '';
            const parts = val.split('-');
            if (parts.length !== 3) return val;
            return `${parts[1]}/${parts[2]}/${parts[0]}`;
        };

        // --- EDIT MODAL LOGIC ---
        window.openEditModal = (id, date, time, c1, c2, trainee) => {
            document.getElementById('edit-doc-id').value = id;
            document.getElementById('edit-date').value = date;
            document.getElementById('edit-time').value = time;
            document.getElementById('edit-crew1').value = c1;
            document.getElementById('edit-crew2').value = c2;
            document.getElementById('edit-trainee').value = trainee || '';
            
            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        };

        document.getElementById('close-edit-modal').addEventListener('click', () => {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        });

        // Delete Logic
        window.deleteShift = async (id) => {
            if(confirm('Are you sure you want to delete this shift?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'emsSchedule', id));
                } catch (e) { alert('Error deleting: ' + e.message); }
            }
        };

        // Add Shift Submit
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser) return;
            const shiftData = {
                date: document.getElementById('add-date').value,
                time: document.getElementById('add-time').value,
                crewMember1: document.getElementById('add-crew1').value,
                crewMember2: document.getElementById('add-crew2').value,
                trainee: document.getElementById('add-trainee').value
            };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'emsSchedule'), shiftData);
                addForm.reset();
            } catch (error) {
                console.error("Error saving:", error);
                alert("Error adding shift.");
            }
        });

        // Edit Shift Submit
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser) return;
            const docId = document.getElementById('edit-doc-id').value;
            const shiftData = {
                date: document.getElementById('edit-date').value,
                time: document.getElementById('edit-time').value,
                crewMember1: document.getElementById('edit-crew1').value,
                crewMember2: document.getElementById('edit-crew2').value,
                trainee: document.getElementById('edit-trainee').value
            };
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'emsSchedule', docId), shiftData);
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
            } catch (error) {
                console.error("Error updating:", error);
                alert("Error updating shift.");
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'emsSchedule');
                onSnapshot(q, (snapshot) => {
                    const shifts = [];
                    snapshot.forEach(doc => shifts.push({ id: doc.id, ...doc.data() }));
                    
                    // Update global cache for duplication checking
                    existingShifts = shifts;

                    shifts.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                    shiftList.innerHTML = shifts.map(shift => `
                        <tr onclick="openEditModal('${shift.id}', '${shift.date}', '${shift.time}', '${shift.crewMember1}', '${shift.crewMember2}', '${shift.trainee || ''}')" class="hover:bg-slate-700/30 transition-colors cursor-pointer group border-b border-slate-700/50 last:border-0">
                            <td class="p-4">
                                <div class="font-bold text-white">${formatDateUS(shift.date)}</div>
                                <div class="text-xs text-slate-400">${shift.time}</div>
                            </td>
                            <td class="p-4">
                                <div class="text-slate-200">1: ${shift.crewMember1}</div>
                                <div class="text-slate-200">2: ${shift.crewMember2}</div>
                                ${shift.trainee ? `<div class="text-xs text-indigo-300 mt-1">T: ${shift.trainee}</div>` : ''}
                            </td>
                            <td class="p-4 text-right">
                                <button onclick="event.stopPropagation(); deleteShift('${shift.id}')" class="text-slate-500 hover:text-red-400 hover:bg-red-500/10 p-2 rounded transition-colors" title="Delete Shift">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                });
            }
        });

        // --- TEXT PARSING LOGIC ---
        
        document.getElementById('open-text-import').addEventListener('click', () => {
            textModal.classList.remove('hidden');
            textModal.classList.add('flex');
        });

        document.getElementById('close-text-modal').addEventListener('click', () => {
            textModal.classList.add('hidden');
            textModal.classList.remove('flex');
        });

        document.getElementById('process-text-btn').addEventListener('click', () => {
            const rawText = document.getElementById('raw-text-input').value;
            parseRawText(rawText);
            textModal.classList.add('hidden');
            textModal.classList.remove('flex');
        });

        const NON_NAMES = [
            'medic', 'emt', 'driver', 'day', 'night', 'shift', 'volunteer', 'trainee', 
            'of', 'time', 'starts', 'following', 'calendar', 'events', 'split', 
            'lieutenant', 'captain', 'chief', 'station', 'fire', 'dept', 'township',
            'red', 'asterisk', 'ffemt', 'ff'
        ];

        function parseRawText(text) {
            const lines = text.split('\n');
            let currentYear = new Date().getFullYear();
            let currentMonth = "12"; 
            let currentDateStr = null;
            let detectedShifts = [];

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;

                // 1. Detect Date Header
                const dateMatch = trimmed.match(/^(Dec|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov)?\s*(\d{1,2})$/i);
                if (dateMatch) {
                    if (dateMatch[1]) {
                        currentMonth = "12"; 
                    }
                    const day = dateMatch[2];
                    currentDateStr = `${currentYear}-${currentMonth}-${day.padStart(2, '0')}`;
                    return;
                }

                // 2. Parse Shift Lines
                const shiftRegex = /([^\d]+?)(\d{2}-\d{2})/g;
                
                let match;
                while ((match = shiftRegex.exec(trimmed)) !== null) {
                    if (!currentDateStr) continue;

                    let rawName = match[1];
                    const rawTime = match[2];
                    const formattedTime = `${rawTime.split('-')[0]}:00 - ${rawTime.split('-')[1]}:00`;

                    // CLEANING LOGIC
                    let cleanedName = rawName.replace(/Red Asterisk/gi, '').replace(/\*/g, '').trim();
                    const cleanNameCheck = cleanedName.replace(/[^a-zA-Z]/g, '').toLowerCase();
                    const isRoleOnly = NON_NAMES.includes(cleanNameCheck);
                    const hasLetters = /[a-zA-Z]/.test(cleanedName);

                    if (!isRoleOnly && hasLetters && cleanedName.length > 2) {
                        detectedShifts.push({
                            date: currentDateStr,
                            time: formattedTime,
                            crew: cleanedName // We push individual names here, will group in showImportModal
                        });
                    }
                }
            });

            showImportModal(detectedShifts);
        }

        function showImportModal(shifts) {
            // Group the flat list by Date+Time before display
            // This merges "Tyler Franklin" and "Kaleb Brodbeck" into one entry if they share a slot
            const groupedMap = new Map();
            shifts.forEach(s => {
                const key = `${s.date}|${s.time}`;
                if (!groupedMap.has(key)) {
                    groupedMap.set(key, { 
                        date: s.date, 
                        time: s.time, 
                        crew: [] // Array of names
                    });
                }
                // Only add unique names
                if(!groupedMap.get(key).crew.includes(s.crew)){
                    groupedMap.get(key).crew.push(s.crew);
                }
            });
            
            // Convert Map back to array for the global state
            importedShifts = Array.from(groupedMap.values());

            previewContainer.innerHTML = '';
            if (importedShifts.length === 0) {
                previewContainer.innerHTML = '<div class="p-4 text-center text-slate-400">No recognizable shifts found in text.</div>';
            } else {
                // Sort by Date, then Time
                importedShifts.sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
                
                importedShifts.forEach((shift, index) => {
                    // Check if this exists in DB to show visual indicator
                    const exists = existingShifts.some(ex => ex.date === shift.date && ex.time === shift.time);
                    const statusBadge = exists 
                        ? `<span class="text-[10px] bg-yellow-500/20 text-yellow-300 px-1.5 py-0.5 rounded ml-2 border border-yellow-500/30">UPDATE</span>`
                        : `<span class="text-[10px] bg-green-500/20 text-green-300 px-1.5 py-0.5 rounded ml-2 border border-green-500/30">NEW</span>`;

                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 bg-slate-700/50 p-3 rounded border border-slate-600';
                    div.innerHTML = `
                        <input type="checkbox" checked class="w-5 h-5 rounded border-gray-500 text-indigo-600 focus:ring-indigo-500 bg-gray-700 import-check" data-index="${index}">
                        <div class="flex-1">
                            <div class="font-bold text-white flex justify-between">
                                <span class="flex items-center">${formatDateUS(shift.date)} ${statusBadge}</span>
                                <span class="text-xs text-indigo-300 bg-indigo-900/30 px-2 py-0.5 rounded">${shift.time}</span>
                            </div>
                            <div class="text-sm text-slate-300 mt-1">
                                <span class="text-slate-500">Crew:</span> ${shift.crew.join(', ')}
                            </div>
                        </div>
                    `;
                    previewContainer.appendChild(div);
                });
            }
            updateImportCount();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function updateImportCount() {
            const count = document.querySelectorAll('.import-check:checked').length;
            importCount.textContent = count;
        }

        previewContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('import-check')) updateImportCount();
        });

        document.getElementById('close-modal').addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); });
        document.getElementById('cancel-import').addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); });

        document.getElementById('confirm-import').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('.import-check:checked');
            const batch = writeBatch(db);
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'emsSchedule');
            let count = 0;
            let updatedCount = 0;
            
            // Iterate over the ALREADY GROUPED list via checkboxes
            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                const shiftData = importedShifts[index];
                
                // --- LOGIC CHANGE: Check for Duplicates ---
                // We check if a shift with the exact same DATE and TIME already exists.
                // If it does, we UPDATE it. If not, we CREATE it.
                
                const existingEntry = existingShifts.find(s => s.date === shiftData.date && s.time === shiftData.time);

                if (existingEntry) {
                    // Update existing
                    const docRef = doc(colRef, existingEntry.id);
                    batch.update(docRef, {
                        crewMember1: shiftData.crew[0] || 'OPEN SHIFT',
                        crewMember2: shiftData.crew[1] || 'OPEN SHIFT',
                        trainee: shiftData.crew[2] || '' 
                    });
                    updatedCount++;
                } else {
                    // Create new
                    const docRef = doc(colRef);
                    batch.set(docRef, {
                        date: shiftData.date,
                        time: shiftData.time,
                        crewMember1: shiftData.crew[0] || 'OPEN SHIFT',
                        crewMember2: shiftData.crew[1] || 'OPEN SHIFT',
                        trainee: shiftData.crew[2] || '' 
                    });
                    count++;
                }
            });

            if (count > 0 || updatedCount > 0) {
                try {
                    await batch.commit();
                    let msg = `Success! `;
                    if (count > 0) msg += `Created ${count} new shifts. `;
                    if (updatedCount > 0) msg += `Updated ${updatedCount} existing shifts.`;
                    alert(msg);
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                } catch (e) { console.error(e); alert("Error committing to database."); }
            } else { alert("No shifts selected."); }
        });
    </script>
</body>
</html>